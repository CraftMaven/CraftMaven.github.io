name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Generate script.js
        run: |
          echo "// Generated by GitHub Actions" > script.js
          echo "name = 'CraftMaven';" >> script.js
          echo "filters = [\"MCP\", \"Forge\", \"Spigot\", \"APIs\"]" >> script.js
          echo "const artifacts = [];" >> script.js
          
          # Loop through repository contents to find artifacts
          for dir in */; do
            if [ -f "${dir}pom.xml" ]; then
              group_id=$(grep -oPm1 "(?<=<groupId>)[^<]+" "${dir}pom.xml")
              artifact_id=$(grep -oPm1 "(?<=<artifactId>)[^<]+" "${dir}pom.xml")
              version=$(grep -oPm1 "(?<=<version>)[^<]+" "${dir}pom.xml")
              
              echo "artifacts.push({" >> script.js
              echo "  name: '${artifact_id}'," >> script.js
              echo "  groupId: '${group_id}'," >> script.js
              echo "  latestVersion: '${version}'," >> script.js
              echo "  files: '$(ls ${dir}/target/*.jar 2>/dev/null | wc -l)'," >> script.js
              echo "  description: 'Auto-generated artifact'," >> script.js
              echo "  lastUpdated: '$(git log -1 --format=%cd --date=relative ${dir})'," >> script.js
              echo "  versions: $(git tag --list "${artifact_id}-*" | wc -l)," >> script.js
              echo "  license: 'MIT'," >> script.js
              echo "  category: 'Auto'" >> script.js
              echo "});" >> script.js
            fi
          done

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}