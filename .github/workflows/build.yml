name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate script.js
        run: |
          echo "// Generated by GitHub Actions" > script.js
          echo "name = 'CraftMaven';" >> script.js
          echo "filters = ['MCP', 'Forge', 'Spigot', 'APIs'];" >> script.js
          echo "const artifacts = [];" >> script.js
          
          # Get repository data and generate artifacts
          echo "const artifacts = [" >> script.js
          for pkg in $(find . -name "pom.xml"); do
            groupId=$(grep -m1 "<groupId>" $pkg | sed 's/.*<groupId>\(.*\)<\/groupId>.*/\1/')
            artifactId=$(grep -m1 "<artifactId>" $pkg | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/')
            version=$(grep -m1 "<version>" $pkg | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
            
            echo "{" >> script.js
            echo "  name: '$artifactId'," >> script.js
            echo "  groupId: '$groupId'," >> script.js
            echo "  latestVersion: '$version'," >> script.js
            echo "  files: '1'," >> script.js
            echo "  description: 'Generated from repository'," >> script.js
            echo "  lastUpdated: new Date().toLocaleDateString()," >> script.js
            echo "  versions: 1," >> script.js
            echo "  license: 'MIT'," >> script.js
            echo "  category: 'APIs'" >> script.js
            echo "}," >> script.js
          done
          echo "];" >> script.js

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          branch: gh-pages